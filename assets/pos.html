<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BigBoss Eren Kuyumculuk - Global POS</title> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- TEMEL AYARLAR (TASARIM %100 KORUNDU) --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f3f3;
            padding: 20px;
            margin: 0;
            padding-bottom: 100px; /* Alt bar i√ßin bo≈üluk */
            -webkit-font-smoothing: antialiased;
        }
        .container {
            max-width: 1350px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            min-height: 80vh;
            position: relative;
        }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; margin-top: 10px; font-size: 1.8rem; }

        /* √úST KONTROLLER */
        .top-controls { position: absolute; top: 25px; right: 25px; display: flex; align-items: center; gap: 12px; z-index: 100; }
        .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; opacity: 0.5; padding: 5px; transition: opacity 0.3s; }
        .settings-btn:hover { opacity: 1; transform: rotate(90deg); }
        .secret-label { font-size: 10px; color: #333; cursor: pointer; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.5; transition: opacity 0.3s; padding: 5px; user-select: none; border: 1px solid transparent; border-radius: 4px; }
        .secret-label:hover { opacity: 1 !important; background-color: #f9f9f9; border-color: #eee; }
        .secret-label input { display: none; }

        /* Fƒ∞YAT BARI */
        .price-bar { display: flex; justify-content: center; align-items: center; gap: 20px; background-color: #2c3e50; padding: 15px; border-radius: 8px; margin-bottom: 20px; flex-wrap: wrap; color: white; }
        .pb-group { display: flex; flex-direction: column; align-items: flex-start; }
        .pb-label { font-size: 0.8rem; color: #bdc3c7; margin-bottom: 3px; }
        .pb-input { font-size: 1.3rem; font-weight: bold; padding: 8px 12px; width: 140px; border: 2px solid #34495e; border-radius: 6px; color: #2c3e50; background: #fff; font-family: 'Inter', sans-serif; }
        .pb-input.buy { border-color: #e67e22; color: #d35400; }
        .pb-input.sell { border-color: #27ae60; color: #27ae60; }
        .harem-link { background-color: #f39c12; color: white; text-decoration: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; height: 45px; margin-top: 18px; }

        /* SEKMELER */
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #eee; gap: 5px; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 15px 25px; font-size: 1.0rem; font-weight: bold; cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px 8px 0 0; border-bottom: none; color: #7f8c8d; transition: all 0.3s; flex: 0 0 auto; white-space: nowrap; }
        .tab-btn.active { color: #fff; background-color: #2c3e50; border-color: #2c3e50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* TABLOLAR VE PANELLER */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background-color: #34495e; color: white; padding: 12px; text-align: left; font-size: 0.90em; white-space: nowrap; }
        tr.main-row td { border-bottom: none; padding-bottom: 4px; vertical-align: middle; background-color: white; }
        td { border-left: 1px solid #ddd; border-right: 1px solid #ddd; padding: 8px; }

        select.data-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
        input.gram-input, input.sales-factor-input, input.qty-input { width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
        input.sales-factor-input { border: 2px solid #27ae60; color: #27ae60; background-color: #f0fff4; }
        
        .price-cell { font-weight: bold; color: #155724; font-size: 1.1em; text-align: right; white-space: nowrap; font-family: 'Inter', sans-serif; }
        .bottom-price-cell { font-weight: bold; color: #2c3e50; font-size: 1.0em; text-align: right; white-space: nowrap; font-family: 'Inter', sans-serif;}
        .cc-cell { font-weight: bold; color: #2980b9; font-size: 1.0em; text-align: right; white-space: nowrap; background-color: #f4faff; font-family: 'Inter', sans-serif;}
        .install-cell { color: #8e44ad; }
        .private-col { background-color: #f9f9f9; }

        /* ARA TOPLAMLAR */
        .total-panel { background-color: #f8f9fa; color: #333; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: flex-end; align-items: center; gap: 20px; border: 1px solid #ddd; }
        .total-group { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .total-label { font-size: 0.8rem; color: #7f8c8d; display: block; margin-bottom: 2px; }
        .total-value { font-size: 1.2rem; font-weight: bold; color: #2c3e50; font-family: 'Inter', sans-serif; }
        
        /* GLOBAL BOTTOM BAR */
        .global-bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to right, #2c3e50, #34495e);
            color: white; padding: 15px 30px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }
        .gbb-total-val { font-size: 2.2rem; font-weight: bold; color: #2ecc71; font-family: 'Inter', sans-serif; text-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1; }
        .btn-global-complete {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white; border: none; padding: 12px 30px; border-radius: 8px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
            transition: transform 0.2s, box-shadow 0.2s; height: 50px; display: flex; align-items: center;
        }
        .btn-global-complete:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.6); }

        /* BUTONLAR */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-add { background-color: #27ae60; color: white; }
        .btn-reset { background-color: #e74c3c; color: white; float: right; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 95%; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-modal { cursor: pointer; font-size: 24px; color: #aaa; align-self: flex-end; margin-top: -15px; margin-right: -10px; }
        
        .payment-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .pay-confirm { padding: 10px 20px; background-color: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        
        body.customer-view .private-col, body.customer-view .bottom-price-cell { display: none !important; }

        /* MOBƒ∞L UYUMLULUK */
        @media (max-width: 768px) {
            .container { padding: 10px; width: 100%; }
            .price-bar { flex-direction: column; gap: 10px; align-items: stretch; }
            .pb-input { width: 100%; font-size: 1.2rem; }
            .global-bottom-bar { flex-direction: column; align-items: stretch; padding: 15px; height: auto; gap: 15px; }
            .btn-global-complete { width: 100%; justify-content: center; }
            
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            td { display: flex; justify-content: space-between; align-items: center; border: none; border-bottom: 1px solid #f0f0f0; padding: 8px 0; width: 100%; }
            td:last-child { border-bottom: none; }
            
            select.data-input { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-controls">
        <button class="settings-btn" onclick="openHistoryModal()" title="Satƒ±≈ü Ge√ßmi≈üi">üìã</button>
        <label class="secret-label">
            <input type="checkbox" id="customerMode" onchange="toggleCustomerMode()"> Sunum
        </label>
    </div>

    <h2 id="pageHeader">BigBoss Eren Kuyumculuk</h2>

    <div class="price-bar">
        <div class="pb-group"><span class="pb-label">HAS ALI≈û (24K)</span><input type="number" id="scrapGoldPrice" class="pb-input buy" placeholder="Alƒ±≈ü" oninput="renderScrapTable()"></div>
        <div class="pb-group"><span class="pb-label">HAS SATI≈û (24K)</span><input type="number" id="goldPrice" class="pb-input sell" placeholder="Satƒ±≈ü" oninput="calculateAll()"></div>
        <a href="https://www.haremaltin.com/" target="_blank" class="harem-link">üìà Canlƒ± Piyasalar</a>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('sales')">TAKI SATI≈û</button>
        <button class="tab-btn" onclick="switchTab('coins')">Zƒ∞YNET & GRAM</button>
        <button class="tab-btn" onclick="switchTab('buy')">HURDA ALI≈û</button>
    </div>

    <div id="sales-tab" class="tab-content active">
        <div class="table-responsive">
            <table id="priceTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">√úr√ºn Cinsi</th>
                        <th style="width: 10%;">Gramaj</th>
                        <th class="private-col" style="width: 10%; text-align:center;">Ref. Milyem</th>
                        <th class="private-col" style="width: 10%; text-align:center;">Satƒ±≈ü Mil.</th>
                        <th style="width: 12%; text-align:right;">Nakit (TL)</th>
                        <th class="private-col" style="width: 10%; text-align:right;">Dip Fiyat</th>
                        <th class="th-single" style="width: 12%; text-align:right;">Tek √áekim</th>
                        <th class="th-install" style="width: 12%; text-align:right;">3 Taksit</th>
                        <th style="width: 5%;">Sil</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-add" onclick="addRow()">+ Yeni Satƒ±r Ekle</button>
            <button class="btn btn-reset" onclick="clearTable()">Tabloyu Temizle</button>
        </div>
        <div class="total-panel">
            <div class="total-group"><span class="total-label">TOPLAM GRAM</span><span id="totalGram" class="total-value" style="color:#7f8c8d; font-size:1.1rem;">0.00 gr</span></div>
            <div class="total-group" style="margin-left:20px;"><span class="total-label">TOPLAM NAKƒ∞T</span><span id="grandTotal" class="total-value">0 TL</span></div>
        </div>
    </div>

    <div id="coins-tab" class="tab-content">
        <div class="table-responsive">
            <table id="coinSellTable">
                <thead>
                    <tr>
                        <th>√úr√ºn Adƒ±</th>
                        <th class="private-col">Has √áarpan</th>
                        <th>Adet</th>
                        <th>Birim Fiyat</th>
                        <th>Toplam</th>
                        <th class="th-single">Tek √áekim</th>
                        <th class="th-install">3 Taksit</th>
                        <th>Sil</th>
                    </tr>
                </thead>
                <tbody id="coinSellBody"></tbody>
            </table>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-add" onclick="addCoinSellRow()">+ √úr√ºn Ekle</button>
            <button class="btn btn-reset" onclick="clearCoinSellTable()">Temizle</button>
        </div>
        <div class="total-panel">
            <div class="total-group"><span class="total-label">Zƒ∞YNET TOPLAM</span><span id="coinSellTotal" class="total-value">0 TL</span></div>
        </div>
    </div>

    <div id="buy-tab" class="tab-content">
        <div class="table-responsive">
            <table id="scrapTable">
                <thead>
                    <tr>
                        <th>√úr√ºn / Cins</th>
                        <th>Miktar (Gr/Ad)</th>
                        <th class="private-col">Alƒ±≈ü Milyemi/Has</th>
                        <th>Tutar (TL)</th>
                        <th>Sil</th>
                    </tr>
                </thead>
                <tbody id="scrapBody"></tbody>
            </table>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-add" onclick="addScrapRow()">+ Satƒ±r Ekle</button>
            <button class="btn btn-reset" onclick="clearScrapTable()">Temizle</button>
        </div>
        <div class="total-panel">
            <div class="total-group"><span class="total-label">√ñDENECEK TUTAR</span><span id="scrapTotal" class="total-value" style="color:#c0392b;">0 TL</span></div>
        </div>
    </div>
</div>

<div class="global-bottom-bar">
    <div style="display:flex; flex-direction:column;">
        <span style="font-size:0.8rem; color:#bdc3c7; margin-bottom:5px;">TAHSƒ∞L EDƒ∞LECEK NET TUTAR</span>
        <span id="gbbTotal" class="gbb-total-val">0 TL</span>
    </div>
    <button class="btn-global-complete" onclick="openGlobalPayment()">‚úÖ ƒ∞≈ûLEMƒ∞ TAMAMLA</button>
</div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal" style="width:450px;">
        <h3>√ñdeme Onayƒ± <span class="close-modal" onclick="closePaymentModal()">&times;</span></h3>
        <div style="background:#eef; padding:15px; border-radius:6px; margin-bottom:20px; text-align:center;">
            <div style="font-size:0.9rem; color:#555;">NET TUTAR</div>
            <div id="modalGlobalTotal" style="font-size:2rem; font-weight:bold; color:#2c3e50;">0 TL</div>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <div class="payment-row">
                <span style="flex:1; font-weight:bold;">üíµ NAKƒ∞T</span>
                <button class="pay-confirm" onclick="confirmSale('cash')">ONAYLA</button>
            </div>
            <div class="payment-row">
                <span style="flex:1; font-weight:bold;">üí≥ TEK √áEKƒ∞M</span>
                <button class="pay-confirm" style="background-color:#2980b9;" onclick="confirmSale('single')">ONAYLA</button>
            </div>
            <div class="payment-row">
                <span style="flex:1; font-weight:bold;">üè¶ 3 TAKSƒ∞T</span>
                <button class="pay-confirm" style="background-color:#8e44ad;" onclick="confirmSale('install')">ONAYLA</button>
            </div>
        </div>
    </div>
</div>

<div id="historyModal" class="modal-overlay">
    <div class="modal">
        <h3>Satƒ±≈ü Ge√ßmi≈üi <span class="close-modal" onclick="closeHistoryModal()">&times;</span></h3>
        <ul id="historyList" style="list-style:none; padding:0; text-align:left; max-height:400px; overflow-y:auto; border-top:1px solid #eee;"></ul>
        <button onclick="clearHistory()" class="btn btn-reset" style="width:100%; margin-top:15px;">Ge√ßmi≈üi Temizle</button>
    </div>
</div>

<script>
    // --- 1. AYARLAR NESNESƒ∞ (BA≈ûLANGI√áTA BO≈û, FLUTTER'DAN DOLACAK) ---
    // Hardcoded deƒüer YOK. Hepsi veritabanƒ±ndan gelecek.
    let currentSettings = {
        // Kart Komisyonlarƒ±
        cc_single_rate: 0, cc_install_rate: 0,
        
        // 14 Ayar Gramaj Aralƒ±klarƒ± (Veritabanƒ±ndan gelecek)
        factor_0_5: 0, factor_5_10: 0, factor_10_15: 0, factor_15_25: 0, factor_25_plus: 0,
        
        // Diƒüer Standartlar
        b22_ajda_sale: 0, b22_sarnel_sale: 0, wedding_plain_sale: 0,
        
        // Ziynet Makaslarƒ±
        ziynet_alis_makas: 0, ziynet_satis_makas: 0,
        packet_gram_sale: 0, cekili_sale: 0
    };
    
    // Canlƒ± Piyasa Verileri (Bot'tan gelecek)
    let currentMarketData = {};

    const coinDefinitions = {
        'e_ceyrek': 'Eski √áeyrek', 'y_ceyrek': 'Yeni √áeyrek',
        'e_yarim': 'Eski Yarƒ±m', 'y_yarim': 'Yeni Yarƒ±m',
        'e_tam': 'Eski Tam', 'y_tam': 'Yeni Tam',
        'e_ata': 'Eski Ata', 'y_ata': 'Yeni Ata',
        'packet_gram': 'Paket Gram', 'cekili': '√áekili'
    };

    // --- FLUTTER ƒ∞LETƒ∞≈ûƒ∞M FONKSƒ∞YONLARI ---
    
    // 1. AYARLARI G√úNCELLE
    function updateFullSettingsFromApp(jsonString) {
        try {
            console.log("Ayarlar Y√ºkleniyor...");
            const newSettings = JSON.parse(jsonString);
            // Gelen ayarlarƒ± mevcutlarƒ±n √ºzerine yaz
            currentSettings = { ...currentSettings, ...newSettings };
            
            // Aray√ºz√º yenile
            updateTableHeaders();
            calculateAll();
            renderScrapTable();
            renderCoinSellTable();
        } catch (e) { console.error("Ayar update hatasƒ±:", e); }
    }

    // 2. Fƒ∞YATLARI G√úNCELLE
    function updatePricesFromApp(jsonData) {
        try {
            currentMarketData = JSON.parse(jsonData);
            
            // Eƒüer kullanƒ±cƒ± o an kutuya tƒ±klamadƒ±ysa g√ºncelle
            const buyInput = document.getElementById('scrapGoldPrice');
            const sellInput = document.getElementById('goldPrice');
            
            if (document.activeElement !== buyInput && currentMarketData.alis) buyInput.value = currentMarketData.alis;
            if (document.activeElement !== sellInput && currentMarketData.satis) sellInput.value = currentMarketData.satis;

            calculateAll(); renderScrapTable(); renderCoinSellTable();
        } catch(e) { console.error("Fiyat update hatasƒ±:", e); }
    }

    // --- TEMEL JS FONKSƒ∞YONLARI ---

    function switchTab(t){ 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.getElementById(t+'-tab').classList.add('active');
        event.target.classList.add('active');
    }

    // --- KRƒ∞Tƒ∞K FONKSƒ∞YON: 14 AYAR GRAMAJ MANTIƒûI ---
    function getFactor(gr) {
        if(gr <= 0) return 0;
        // Flutter'dan gelen deƒüi≈üken isimleriyle Bƒ∞REBƒ∞R aynƒ± olmalƒ±
        // Veri gelmezse 0 d√∂ner, hardcoded deƒüer YOK.
        if(gr < 5) return parseFloat(currentSettings.factor_0_5 || 0);
        if(gr < 10) return parseFloat(currentSettings.factor_5_10 || 0);
        if(gr < 15) return parseFloat(currentSettings.factor_10_15 || 0);
        if(gr < 25) return parseFloat(currentSettings.factor_15_25 || 0);
        return parseFloat(currentSettings.factor_25_plus || 0);
    }

    // --- TAKI HESAPLAMA ---
    function calculateAll() {
        document.querySelectorAll('#priceTable .main-row').forEach(row => calculateRow(row));
        updateTotals();
    }

    function calculateRow(row) {
        const type = row.querySelector('select').value;
        const gram = parseFloat(row.querySelector('.gram-input').value)||0;
        const gold = parseFloat(document.getElementById('goldPrice').value)||0;
        
        let factor = 0;
        let factorInput = row.querySelector('.factor-input');
        
        // 1. Milyem Belirleme
        if(type === 'std') factor = getFactor(gram);
        else if(type === 'b22_ajda') factor = currentSettings.b22_ajda_sale;
        else if(type === 'b22_sarnel') factor = currentSettings.b22_sarnel_sale;
        else if(type === 'wedding_plain') factor = 0.585 + (currentSettings.wedding_plain_sale || 0);
        
        // 2. Input Kontrol√º (Otomatik mi Manuel mi?)
        if(factorInput.getAttribute('data-locked') !== 'true') {
             factorInput.value = factor.toFixed(3);
        } else {
             factor = parseFloat(factorInput.value)||0;
        }

        // 3. Fiyat Hesabƒ±
        let price = gram * gold * factor;
        if(type === 'wedding_plain') price = gold * ((gram * 0.585) + (currentSettings.wedding_plain_sale||0));

        // 4. Ekrana Basma
        row.querySelector('.price-cell').innerText = Math.round(price).toLocaleString('tr-TR') + " TL";
        row.querySelector('.price-cell').setAttribute('data-val', price);
        row.querySelector('.bottom-price-cell').innerText = Math.round(gram * gold * (type.startsWith('b22') ? 0.92 : 0.60)).toLocaleString('tr-TR');

        let sRate = currentSettings.cc_single_rate || 0;
        let iRate = currentSettings.cc_install_rate || 0;
        row.querySelector('.single-cell').innerText = Math.round(price * (1 + sRate/100)).toLocaleString('tr-TR');
        row.querySelector('.install-cell').innerText = Math.round(price * (1 + iRate/100)).toLocaleString('tr-TR');
    }

    // --- Zƒ∞YNET SATI≈û HESAPLAMA (MAKASLI) ---
    function renderCoinSellTable() {
        const gold = parseFloat(document.getElementById('goldPrice').value)||0;
        let total = 0;
        document.querySelectorAll('#coinSellBody tr').forEach(row => {
            const key = row.querySelector('select').value;
            const qty = parseFloat(row.querySelector('.qty-input').value)||0;
            
            let factor = 0;
            // Canlƒ± Veri Var mƒ±?
            if(currentMarketData[key + '_satis_has']) {
                // Harem √áarpanƒ± + Bizim Makas
                factor = currentMarketData[key + '_satis_has'] + (currentSettings.ziynet_satis_makas || 0);
            } else {
                factor = 1; // Veri yoksa 1 (G√ºvenlik)
            }
            
            let unitPrice = gold * factor;
            // Paket/√áekili ƒ∞stisnasƒ±
            if(key === 'packet_gram') unitPrice = gold * (currentSettings.packet_gram_sale||0);
            if(key === 'cekili') unitPrice = gold * (currentSettings.cekili_sale||0);

            let rowPrice = unitPrice * qty;
            row.querySelector('.factor-display').innerText = factor.toFixed(4);
            row.querySelector('.unit-price').innerText = Math.round(unitPrice).toLocaleString('tr-TR');
            row.querySelector('.row-total').innerText = Math.round(rowPrice).toLocaleString('tr-TR') + " TL";
            row.querySelector('.row-total').setAttribute('data-val', rowPrice);
            
            let sRate = currentSettings.cc_single_rate || 0;
            let iRate = currentSettings.cc_install_rate || 0;
            row.querySelector('.single-cell').innerText = Math.round(rowPrice * (1 + sRate/100)).toLocaleString('tr-TR');
            row.querySelector('.install-cell').innerText = Math.round(rowPrice * (1 + iRate/100)).toLocaleString('tr-TR');
            
            total += rowPrice;
        });
        document.getElementById('coinSellTotal').innerText = Math.round(total).toLocaleString('tr-TR') + " TL";
        updateTotals();
    }

    // --- HURDA HESAPLAMA ---
    function renderScrapTable() {
         const gold = parseFloat(document.getElementById('scrapGoldPrice').value)||0;
         let total = 0;
         document.querySelectorAll('#scrapBody tr').forEach(row => {
            const key = row.querySelector('select').value;
            const qty = parseFloat(row.querySelector('.qty-input').value)||0;
            let factor = 0;
            
            if(key.startsWith('scrap')) {
                // Hurda Gramaj Limiti Kontrol√º
                factor = currentSettings[key] || 0;
                let limit = currentSettings.scrap_high_gram_limit || 9999;
                if(qty >= limit && currentSettings[key+'_high']) {
                    factor = currentSettings[key+'_high'];
                }
            } else if(currentMarketData[key + '_alis_has']) {
                // Ziynet Alƒ±≈üta Makas D√º≈ü√ºl√ºr
                factor = currentMarketData[key + '_alis_has'] - (currentSettings.ziynet_alis_makas || 0);
            }
            
            let val = 0;
            if(key.startsWith('scrap')) val = qty * gold * factor;
            else val = qty * factor * gold;
            
            row.querySelector('.factor-display').innerText = factor.toFixed(4);
            row.querySelector('.row-total').innerText = Math.round(val).toLocaleString('tr-TR') + " TL";
            row.querySelector('.row-total').setAttribute('data-val', val);
            total += val;
         });
         document.getElementById('scrapTotal').innerText = Math.round(total).toLocaleString('tr-TR') + " TL";
         updateTotals();
    }

    function updateTotals() {
        let t1 = 0; document.querySelectorAll('#priceTable .price-cell').forEach(c=>t1+=parseFloat(c.getAttribute('data-val'))||0);
        let t2 = parseFloat(document.getElementById('coinSellTotal').innerText.replace(/\./g,'').replace(' TL',''))||0;
        let t3 = parseFloat(document.getElementById('scrapTotal').innerText.replace(/\./g,'').replace(' TL',''))||0;
        
        let gr = 0; document.querySelectorAll('#priceTable .gram-input').forEach(i => gr += parseFloat(i.value)||0);
        document.getElementById('totalGram').innerText = gr.toFixed(2) + " gr";

        document.getElementById('grandTotal').innerText = Math.round(t1).toLocaleString('tr-TR') + " TL";
        let net = (t1 + t2) - t3;
        
        document.getElementById('gbbTotal').innerText = Math.round(net).toLocaleString('tr-TR') + " TL";
        document.getElementById('gbbTotal').style.color = net >= 0 ? "#2ecc71" : "#e74c3c";
        document.getElementById('modalGlobalTotal').innerText = Math.round(net).toLocaleString('tr-TR') + " TL";
    }

    function updateTableHeaders() {
        let s = currentSettings.cc_single_rate || 0;
        let i = currentSettings.cc_install_rate || 0;
        document.querySelectorAll('.th-single').forEach(e => e.innerText = `Tek √áekim (%${s})`);
        document.querySelectorAll('.th-install').forEach(e => e.innerText = `3 Taksit (%${i})`);
    }

    // --- SATIR EKLEME ---
    function addRow() {
        const tbody = document.querySelector('#priceTable tbody');
        const tr = document.createElement('tr');
        tr.className = 'main-row';
        tr.innerHTML = `<td><select class="data-input" onchange="calculateAll()" style="width:100%"><option value="std">Standart (14K)</option><option value="b22_ajda">Ajda (22K)</option><option value="b22_sarnel">≈ûarnel (22K)</option><option value="wedding_plain">Alyans</option></select></td>
        <td><input type="number" class="gram-input" oninput="calculateAll()"></td>
        <td class="private-col" style="text-align:center">-</td>
        <td class="private-col" style="text-align:center"><input type="number" class="sales-factor-input factor-input" step="0.001" data-locked="false" oninput="this.setAttribute('data-locked','true'); calculateAll()"></td>
        <td class="price-cell">0 TL</td><td class="private-col bottom-price-cell">-</td><td class="single-cell cc-cell">0 TL</td><td class="install-cell cc-cell">0 TL</td>
        <td style="text-align:center; color:red; cursor:pointer;" onclick="this.parentElement.remove(); calculateAll()">X</td>`;
        tbody.appendChild(tr);
    }
    function addCoinSellRow() {
        const tbody = document.getElementById('coinSellBody');
        const tr = document.createElement('tr');
        let opts=""; for(let k in coinDefinitions) opts+=`<option value="${k}">${coinDefinitions[k]}</option>`;
        tr.innerHTML = `<td><select class="data-input" onchange="renderCoinSellTable()" style="width:100%">${opts}</select></td>
        <td class="private-col factor-display" style="text-align:center">-</td><td><input type="number" class="qty-input" value="1" oninput="renderCoinSellTable()"></td>
        <td class="unit-price" style="text-align:right">0</td><td class="row-total" style="font-weight:bold; text-align:right">0 TL</td>
        <td class="single-cell cc-cell">0</td><td class="install-cell cc-cell">0</td>
        <td style="text-align:center; color:red; cursor:pointer;" onclick="this.parentElement.remove(); renderCoinSellTable()">X</td>`;
        tbody.appendChild(tr); renderCoinSellTable();
    }
    function addScrapRow() {
        const tbody = document.getElementById('scrapBody');
        const tr = document.createElement('tr');
        let opts=`<option value="scrap_24">24 Ayar</option><option value="scrap_22">22 Ayar</option><option value="scrap_18">18 Ayar</option><option value="scrap_14">14 Ayar</option><option value="scrap_8">8 Ayar</option>`;
        for(let k in coinDefinitions) if(!k.includes('gram') && !k.includes('cekili')) opts+=`<option value="${k}">${coinDefinitions[k]}</option>`;
        tr.innerHTML = `<td><select class="data-input" onchange="renderScrapTable()" style="width:100%">${opts}</select></td>
        <td><input type="number" class="qty-input" oninput="renderScrapTable()"></td>
        <td class="private-col factor-display" style="text-align:center">-</td><td class="row-total" style="font-weight:bold; text-align:right">0 TL</td>
        <td style="text-align:center; color:red; cursor:pointer;" onclick="this.parentElement.remove(); renderScrapTable()">X</td>`;
        tbody.appendChild(tr);
    }
    function clearTable() { document.querySelector('#priceTable tbody').innerHTML=""; addRow(); calculateAll(); }
    function clearCoinSellTable() { document.getElementById('coinSellBody').innerHTML=""; addCoinSellRow(); }
    function clearScrapTable() { document.getElementById('scrapBody').innerHTML=""; addScrapRow(); }

    // --- MODAL & Dƒ∞ƒûERLERƒ∞ ---
    function openGlobalPayment() { document.getElementById('paymentModal').style.display='flex'; }
    function closePaymentModal() { document.getElementById('paymentModal').style.display='none'; }
    function confirmSale(type) { 
        let net = document.getElementById('gbbTotal').innerText;
        let h = JSON.parse(localStorage.getItem('history')) || [];
        h.unshift({date: new Date().toLocaleTimeString(), total: net, type: type});
        localStorage.setItem('history', JSON.stringify(h));
        closePaymentModal();
        alert('ƒ∞≈ülem Ba≈üarƒ±lƒ±!');
        clearTable(); clearCoinSellTable(); clearScrapTable();
    }
    function openHistoryModal() {
        const list = document.getElementById('historyList');
        list.innerHTML = "";
        let h = JSON.parse(localStorage.getItem('history')) || [];
        if(h.length === 0) list.innerHTML = "<li style='padding:10px; color:#999;'>Kayƒ±t yok.</li>";
        h.forEach(item => {
            list.innerHTML += `<li style="border-bottom:1px solid #eee; padding:10px;">
                <span style="color:#7f8c8d; font-size:0.8rem;">${item.date}</span>
                <b style="float:right;">${item.total}</b>
                <div style="font-size:0.8rem;">${item.type}</div>
            </li>`;
        });
        document.getElementById('historyModal').style.display='flex';
    }
    function closeHistoryModal() { document.getElementById('historyModal').style.display='none'; }
    function clearHistory() { if(confirm("Emin misin?")) { localStorage.removeItem('history'); openHistoryModal(); } }
    function toggleCustomerMode() {
        if(document.getElementById('customerMode').checked) document.body.classList.add('customer-view');
        else document.body.classList.remove('customer-view');
    }

    window.onload = function() { addRow(); addCoinSellRow(); addScrapRow(); }
</script>
</body>
</html>